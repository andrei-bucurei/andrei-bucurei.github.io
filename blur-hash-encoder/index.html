<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlurHash Encoder</title>

    <!-- Google Tag Manager -->
    <script>
        (function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-W9ZLXHD6');
    </script>
    <!-- End Google Tag Manager -->

    <script src="blurhash.min.js"></script>
    <script src="https://unpkg.com/mustache@latest"></script>

    <script id="item-template" type="x-tmpl-mustache">
        <div class="item">
            <div class="thumbnail image-thumbnail">
            </div>
            <div class="spacer"></div>
            <div class="thumbnail blurhash-thumbnail">
            </div>
            <div class="spacer"></div>
            <div class="info">
                <div>
                    BlurHash: <input class="blurhash" type="text" value='{{blurHash}}' readonly>
                    <button onclick="copyToClipboard('{{blurHash}}')">â§‰</button>
                </div>
                <div class="truncate">
                    <a href="{{imageUrl}}" target="_blank">{{imageUrl}}</a>
                </div>
                <div class="truncate">
                    Encode date: {{startDate}}
                </div>
                <div class="truncate">
                    Encode duration: {{durationInMs}} ms
                </div>
            
            </div>
        </div>
    </script>

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 1em;
        }

        .item {
            padding-top: 0.5em;
            padding-bottom: 0.5em;
            display: flex;
        }

        .thumbnail {
            width: 128px;
            height: 128px;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            box-shadow: 0px 2px 16px lightgrey;
        }

        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .spacer {
            width: 16px;
            flex-shrink: 0;
        }

        .info {
            flex-grow: 1;
            min-width: 240px;
        }

        .truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .blurhash {
            font-family: monospace;
            width: 40ch;
        }
    </style>
</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript>
        <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W9ZLXHD6" height="0" width="0"
            style="display:none;visibility:hidden">
        </iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->

    <h1>BlurHash Encoder (WIP)</h1>

    <div>
        <label for="image-url">Image URL:</label>
        <input type="text" id="image-url" placeholder="Enter image URL"
            value="https://images.pexels.com/photos/2486168/pexels-photo-2486168.jpeg"
            onkeydown="if (event.key === 'Enter') encode()">
    </div>

    <div id="items">

    </div>


    <script>
        const itemTemplate = document.getElementById('item-template').innerHTML;
        const items = document.getElementById('items');
        const input = document.getElementById('image-url');

        async function encode() {
            const imageUrl = input.value;
            const corsProxyImageUrl = `https://corsproxy.io/?${encodeURIComponent(imageUrl)}`;

            if (!imageUrl) {
                alert('Please enter an image URL');
                return;
            }

            input.value = '';

            const startDate = new Date();

            let useCorsProxy = false;
            const image = new Image();
            image.crossOrigin = 'Anonymous';
            image.src = imageUrl;

            image.onload = async () => {
                image.onload = null;

                const maxDimension = 64;
                let width = image.width;
                let height = image.height;

                if (width > height) {
                    if (width > maxDimension) {
                        height = Math.round((height * maxDimension) / width);
                        width = maxDimension;
                    }
                } else {
                    if (height > maxDimension) {
                        width = Math.round((width * maxDimension) / height);
                        height = maxDimension;
                    }
                }

                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(image, 0, 0, image.width, image.height, 0, 0, width, height);

                const imageData = ctx.getImageData(0, 0, width, height);

                const blurHash = await blurhash.encodePromise(imageData.data, imageData.width, imageData.height, 4, 4);
                const blurHashImageData = await blurhash.decode(blurHash, width, height, 1.0);
                const blurHashImage = await blurhash.getImageDataAsImageWithOnloadPromise(blurHashImageData, width, height);

                const endDate = new Date();
                const durationInMs = endDate - startDate;

                const itemData = {
                    blurHash,
                    imageUrl,
                    startDate,
                    endDate,
                    durationInMs,
                };

                const itemHTML = Mustache.render(itemTemplate, itemData);
                var template = document.createElement('template');
                template.innerHTML = itemHTML;
                const item = template.content;
                item.querySelector('.thumbnail.image-thumbnail').appendChild(image);
                item.querySelector('.thumbnail.blurhash-thumbnail').appendChild(blurHashImage);
                items.prepend(item);
            };

            image.onerror = (e) => {
                if (!useCorsProxy) {
                    useCorsProxy = true;
                    image.src = corsProxyImageUrl;
                }
            };
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                console.log('Text copied to clipboard');
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
        }
    </script>
</body>

</html>